
{% include "store/base.html" %}


{% load static %}


{% block content %}

<style>
    
    body 
    {
        
        background-color: gray;
    
    }


</style>


    <body>

        <br>

        <div class="container bg-white shadow-md p-5" style="width:500px; border-radius:20px;">

            <form id="form" onsubmit="event.preventDefault();">
                <div>
                    <div style="display: flex; align-items: center; justify-content: center; position: relative;">
                        <a href="{% url 'cart-summary' %}" style="position: absolute; left: 0; color: #717070c8;">
                            <i class="fa fa-undo fa-2x" aria-hidden="true"></i>
                        </a>
                        <h3 style="margin: 0;">Complete your order</h3>
                    </div>
                    <hr>
                    <p> Please enter in the shipping address below. </p>
                    <br>
                    <div class="form-field">
                    
                        <input class="form-control validate" id="name" type="text" placeholder="Full name*" autocomplete="off" value="{{shipping.full_name}}" required>

                    </div>
                    <br>
                    <div class="form-field">

                        <input class="form-control validate" id="email" type="email" placeholder="Email address*" autocomplete="off" value="{{shipping.email}}" required>

                    </div>
                    <br>
                    <div class="form-field">

                        <input class="form-control validate" id="address1" type="text" placeholder="Address 1*" autocomplete="off" value="{{shipping.address1}}" required>

                    </div>
                    <br>
                    <div class="form-field">

                        <input class="form-control validate" id="address2" type="text" placeholder="Address 2*" autocomplete="off" value="{{shipping.address2}}" required>

                    </div>
                    <br>
                    <div class="form-field">

                        <input class="form-control validate" id="city" type="text" placeholder="City*" autocomplete="off" value="{{shipping.city}}" required>

                    </div>
                    <br>
                    <div class="form-field">

                        <input class="form-control" id="state" type="text" placeholder="State (Optional)" autocomplete="off" value="{{shipping.state}}">

                    </div>
                    <br>
                    <div class="form-field">

                        <input class="form-control" id="zipcode" type="text" placeholder="Zip code (Optional)" autocomplete="off" value="{{shipping.zipcode}}">

                    </div>
                </div>
                <br>
                <br>
                <!-- Paypal  -->
                <div id="paypal-button-container"></div>
                 <script src="https://www.paypal.com/sdk/js?client-id=AfQicZXVD-nvuVqN_Kay0_ZAlAv5Xyp0L-oqAcmqW0iKkSm2_zhQY9ZgmCuK38QjL8trIB9s7DaLXIKH&currency=USD&intent=capture&enable-funding=venmo" data-sdk-integration-source="integrationbuilder"></script>
            </form>

        </div>

        <br>

    </body>


    <!-- Ajax integration -->

    

<script>

// Paypal Script

const myPaypalButton = paypal.Buttons({         
        // https://developer.paypal.com/docs/checkout/standard/customize/buttons-style-guide/
        style: {
        color: "blue",
        shape: "rect",
        layout: "vertical"
        },

        onInit: function(data, actions) {           // 初始化完成時應執行...

            actions.disable();                      // 禁用按鈕

            function checkInputs(){

                let order_verified = 'Yes';        //宣告一個變數 order_verified，並給它初始值 'Yes' 預設「訂單驗證狀態為通過」

                $(':input[required]').each(function(){ // 選取所有的表單輸入元素 + 有屬性 required(必填)，對欄位逐一執行...
                    if($(this).val() == ''){          // 如果找到任何一個空欄位，就會執行...
                        order_verified = 'No'
                        return false

                    }
                });

                if (order_verified == 'Yes'){

                    actions.enable();
                }else {

                    actions.disable();
                }
            }

            checkInputs();

            document.querySelectorAll('.validate').forEach(item =>{ // 找出 HTML 中所有 class 為 validate 的元素， 針對每一個元素命名為 item，執行...

                item.addEventListener('input', checkInputs);       // 對每一個item加上事件監聽器（ input - 欄位內容實際改變）。 並在事件發生時執行...

            });
        },


        createOrder: () => {       
            return $.ajax({
                type : 'POST',
                url  : '{% url "create-paypal-order" %}',
                data :{csrfmiddlewaretoken: '{{ csrf_token }}'},
            }).then(json => json.id);                                   
                               
        },        





        onApprove: (data) => {                         
            return $.ajax({
                type: 'POST' , 
                url: '{% url "capture-paypal-order" %}' , 
                data:{
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                    order_id : data.orderID,

                    name: $('#name').val(),
                    email: $('#email').val(),
                    address1: $('#address1').val(),
                    address2: $('#address2').val(),
                    city: $('#city').val(),
                    state: $('#state').val(),
                    zipcode: $('#zipcode').val(),         
                },

            })
            .done(()=>{
                window.location.replace("{% url 'payment-success' %}");
            })
            .fail((jqXHR, textStatus, errorThrown)=>{
                console.log(textStatus);
                console.log(errorThrown);
                console.log(jqXHR.status);
                console.log(jqXHR.responseText);
                window.location.replace("{% url 'payment-failed' %}");

            })
            

        },







        // handle unrecoverable errors
        onError: (err) => {                                                                //嚴重Error： 發生在用戶點擊按鈕、進入結帳流程後，但交易過程中發生了不可恢復的錯誤。這個錯誤發生時，通常連 onApprove 裡面的邏輯都還沒開始執行。
            console.error('An error prevented the buyer from checking out with PayPal');

        }
    });

    myPaypalButton                                                              // 最前面建立的 PayPal 按鈕實例；包含了所有 callback（createOrder、onApprove、onError）和樣式設定
        .render("#paypal-button-container")                                             //  把按鈕插入到頁面上指定的 DOM 元素 (HTML 元素的 CSS 選擇器)
        .catch((err) => {                                                               //如果按鈕渲染失敗（例如網路問題、PayPal SDK 載入失敗）.catch() 會捕捉錯誤，並執行裡面的程式
            console.error('PayPal Buttons failed to render');
        });



</script>



{% endblock %}